<?php
$post['id']='9';
$post['title']='Javascript onbeforeunload — як попереджати юзера про незбережені дані у формі';
$post['text']='<img src="https://poohitan.com/images/facebookOnbeforeunload.jpg"><br><br>Напевно кожному знайома ситуація: пишеш ти комусь довжелезне повідомлення, допис на форумі, або просто заповнюєш велику форму реєстрації, і тут РАПТОВО випадково клацаєш на якесь посилання чи закриваєш вкладку… і все те, що ти натхненно писав протягом останніх n хвилин, зникає. Кілька секунд йде на усвідомлення того, що сталось, і прийняття факту, що вже нічого не повернути. Після цього ти проклинаєш розробників сайту, рвеш на собі волосся, розбиваєш монітор, <strike>хапаєшся за сокиру і йдеш вбивати</strike>. <br><br>Тому хороший сайт повинен попереджати юзера про те, що у формі залишились незбережені дані, коли той пробує покинути сторінку. Звісно, таке не варто робити для всіх форм підряд. Наприклад, для форми логіну, де користувач вводить лише юзернейм і пароль, це зайве. Але для форм, де передбачається введення великої кількості даних, видавати таке попередження є правилом хорошого тону.<br><br>Робиться таке дуже просто через івент <b>onbeforeunload </b>у Javascript. <cut> <span id="cut"><img id="scissors" src="templates/cut.png" border="0"></span></cut><br><br><b>onbeforeunload </b>спрацьовує тоді, коли користувач пробує покинути сторінку (будь-яким чином — закрити вікно/вкладку, оновити сторінку, перейти за якимось посиланням і тд.) Щоб при закритті сторінки відкрилось попередження, треба просто обробити цей івент. А саме, коли він спрацьовує, треба викликати якусь функцію, яка має всього-на-всього повернути певний текст. Браузер використає цей текст в якості повідомлення, яке буде показано користувачу. Щоправда, Firefox <a target="" title="" href="https://bugzilla.mozilla.org/show_bug.cgi?id=641509">ігнорує текст</a>, наданий сайтом, і завжди показує своє стандартне повідомлення. Але це ще нічого, наприклад, Opera взагалі не вміє працювати з <b>onbeforeunload</b>, там сторінка просто закриється, і все. В Chrome, IE, Safari все добре :)<br><br>Найпростіший приклад обробки івенту <b>onbeforeunload</b>:<br><br><br><div class="pastebin">Код з <a href="http://pastebin.com/uELBcWb5">http://pastebin.com/uELBcWb5</a></div><script src="https://pastebin.com/embed_js.php?i=uELBcWb5"></script><br>Якщо додати до сторінки такий скрипт, то при спробі покинути її, у Chrome ми побачимо таке повідомлення:<br><br><div align="center"><img src="https://poohitan.com/images/onbeforeunloadChrome_1283912837.jpg"><br></div><br><div align="left">А у Firefox — таке:</div><div align="left"><br></div><div align="center"><img src="https://poohitan.com/images/onbeforeunloadFirefox_123123123.jpg"></div><br>Тепер нам потрібно зробити так, щоб це повідомлення відображалось не завжди, а лише тоді, коли користувач вніс якісь зміни у форму на сторінці. Як визначити, чи користувач вніс зміни у форму? Просто порівняти ті дані, які були у формі при завантаженні сторінки, і ті, які є у формі при спрацюванні <b>onbeforeunload</b>.<br><br>Для початку створимо сторінку з простою формою, яка складається лише з одного поля для тексту і однієї кнопки. HTML код:<br><br><div class="pastebin">Код з <a href="http://pastebin.com/v8n2yspV">http://pastebin.com/v8n2yspV</a></div><script src="https://pastebin.com/embed_js.php?i=v8n2yspV"></script><br>А тепер напишемо скрипт, який перетворить цю туфтову і примітивну форму в круту та інтерактивну:<br><br><div class="pastebin">Код з <a href="http://pastebin.com/GMeAmW9D">http://pastebin.com/GMeAmW9D</a></div><script src="https://pastebin.com/embed_js.php?i=GMeAmW9D"></script><br>Скрипт зовсім елементарний. При відкритті сторінки спрацьовує івент <b>onload</b> і викликається функція <b>saveOldData()</b>. Вона витягує вміст з форми <b>someForm </b>і записує його у змінну <b>oldData</b>. Далі на сторінці щось відбувається, юзер щось робить, можливо, міняє вміст форми, а може й ні. При закритті сторінки спрацьовує <b>onbeforeunload</b>, викликається функція <b>toCloseOrNotToClose()</b>. Спершу вона зберігає поточний вміст форми у змінну <b>newData</b>, а потім перевіряє, чи <b>oldData </b>і <b>newData </b>однакові. Якщо ні, значить користувач вніс зміни у форму, і тоді відображається попередження.<br><br>Все круто, але є одне але :). Якщо для надсилання даних із форми використовується метод POST, то коли юзер натисне кнопку «Надіслати», форма спробує перенаправити його на іншу сторінку, і йому, знову ж таки, буде відображено повідомлення про те, що у формі є незбережені зміни. У цьому випадку показувати таке повідомлення тупо, бо ж юзер якраз і хоче зберегти ці зміни, натискаючи кнопку. Тому треба трошки підправити наш код. <br><br>Додамо змінну <b>isDataSubmitted</b>, яка буде відповідати за те, чи були дані з форми збережені. За замовчуванням вона буде дорівнювати <b>false</b>. Тепер додамо функцію <b>submitData()</b>, яка буде міняти значення <b>isDataSubmitted</b> на <b>true</b>. В функцію <b>toCloseOrNotToClose<span class="br0">()</span></b> крім перевірки на те, чи нові дані з форми відрізняються від старих, додамо перевірку на те, чи <b>isDataSubmitted</b> дорівнює <b>true</b>.<br><br><div class="pastebin">Код з <a href="http://pastebin.com/z3FWaPN3">http://pastebin.com/z3FWaPN3</a></div><script src="https://pastebin.com/embed_js.php?i=z3FWaPN3"></script><br>І зробимо так, щоб при кліку на нашу кнопку викликалась функція <b>submitData()</b>. <br><br><div class="pastebin">Код з <a href="http://pastebin.com/6fFYz9HA">http://pastebin.com/6fFYz9HA</a></div><script src="https://pastebin.com/embed_js.php?i=6fFYz9HA"></script><br>Ось і все. Тепер попередження буде відображатись тоді, коли юзер вніс зміни у форму і покидає сторінку таким чином, що ці зміни можуть втратитись.<br><br>Архів з цим прикладом <a target="" title="" href="https://poohitan.com/files/onbeforeunload_example.zip">тут</a>.<br><br>На додаток, стаття від Студії Лебедєва про те, як робити хороші з точки зору юзабіліті форми <a target="" title="" href="http://www.artlebedev.ru/tools/technogrette/etc/forms/">http://www.artlebedev.ru/tools/technogrette/etc/forms/</a><br><b><span class="sy0"></span></b>';
$post['hidden']='';
$post['subs']='';
$post['holdtime']='';
$post['dietime']='';
$post['close']='';
$post['nocomm']='';
$post['commhide']='';
$post['attach']='';
$post['commpriv']='';
$post['nobr']='';
?>